"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var e=require("tslib"),s=require("react"),t=require("react/jsx-runtime"),a=require("../../context/TUIKitContext.js"),r=require("../../context/TUIChatStateContext.js"),n=require("../../context/TUIChatActionContext.js"),i=require("../../context/ComponentContext.js"),o=require("./hooks/useCreateTUIChatStateContext.js"),u=require("../TUIMessage/TUIMessage.js");require("../Icon/config.js"),require("../Icon/type.js");var c=require("../../constants.js"),g=require("../Toast/index.js");require("tim-js-sdk/tim-js-friendship"),require("date-fns"),require("../TUIMessage/MessageContext.js");var T=require("./hooks/useMessageReceviedListener.js"),d=require("./TUIChatState.js"),I=require("./hooks/useCreateMessage.js"),M=require("./hooks/useHandleMessageList.js"),l=require("./hooks/useHandleMessage.js"),_=require("../TUIChatHeader/TUIChatHeader.js"),v=require("../TUIMessageList/TUIMessageList.js"),C=require("../TUIMessageInput/TUIMessageInput.js"),h=require("../EmptyStateIndicator/EmptyStateIndicator.js");function p(e){return e&&"object"==typeof e&&"default"in e?e:{default:e}}function j(r){var n=r.conversation,i=r.EmptyPlaceholder,o=void 0===i?t.jsx(h.EmptyStateIndicator,{listType:"chat"}):i,u=a.useTUIKitContext("TUIChat"),c=u.conversation,g=u.tim,T=n||c;return(null==T?void 0:T.conversationID)?s.createElement(m,e.__assign({tim:g},r,{conversation:T,key:T.conversationID})):o}function m(a){var h=this,p=a.tim,j=a.conversation,m=a.className,x=a.children,S=a.TUIMessage,E=a.TUIChatHeader,U=a.TUIMessageInput,f=a.InputPlugins,q=a.MessagePlugins,P=a.MessageContext,H=a.InputQuote,y=a.onMessageRecevied,L=s.useReducer(d.chatReducer,e.__assign(e.__assign({},d.initialState),{conversation:j})),A=L[0],R=L[1],N=s.useRef(null),D=s.useRef(),O=o(e.__assign({tim:p,conversation:j,messageListRef:N,textareaRef:D},A)),w=I.useCreateMessage({tim:p,conversation:j}),b=w.createTextMessage,k=w.createFaceMessage,Y=w.createImageMessage,F=w.createVideoMessage,G=w.createFileMessage,Q=M.useHandleMessageList({tim:p,conversation:j,state:A,dispatch:R}),K=Q.getMessageList,V=Q.updateMessage,X=Q.editLocalmessage,z=Q.removeMessage,B=l.useHandleMessage({state:A,dispatch:R,editLocalmessage:X}).operateMessage,J=function(s){return e.__awaiter(h,void 0,void 0,(function(){var t;return e.__generator(this,(function(e){switch(e.label){case 0:V([s]),e.label=1;case 1:return e.trys.push([1,3,,4]),[4,p.sendMessage(s)];case 2:return e.sent(),X(s),[3,4];case 3:throw t=e.sent(),g.Toast({text:t,type:"error"}),X(s),new Error(t);case 4:return[2]}}))}))},W=function(){return e.__awaiter(h,void 0,void 0,(function(){var s;return e.__generator(this,(function(e){switch(e.label){case 0:return A.isCompleted?(R({type:c.CONSTANT_DISPATCH_TYPE.SET_NO_MORE,value:!0}),[2]):(R({type:c.CONSTANT_DISPATCH_TYPE.SET_HIGH_LIGHTED_MESSAGE_ID}),[4,K({nextReqMessageID:A.nextReqMessageID})]);case 1:return s=e.sent(),R({type:c.CONSTANT_DISPATCH_TYPE.SET_HISTORY_MESSAGELIST,value:s.data.messageList}),R({type:c.CONSTANT_DISPATCH_TYPE.SET_IS_COMPLETE,value:s.data.isCompleted}),R({type:c.CONSTANT_DISPATCH_TYPE.SET_NEXT_REQ_MESSAGE_ID,value:s.data.nextReqMessageID}),[2]}}))}))};T.useMessageReceviedListener(V,y),s.useEffect((function(){e.__awaiter(h,void 0,void 0,(function(){return e.__generator(this,(function(e){switch(e.label){case 0:return[4,W()];case 1:return e.sent(),[2]}}))}))}),[]);var Z=s.useMemo((function(){return{sendMessage:J,removeMessage:z,editLocalmessage:X,updateMessage:V,createTextMessage:b,createFaceMessage:k,createImageMessage:Y,createVideoMessage:F,createFileMessage:G,operateMessage:B,loadMore:W}}),[J,z,V,b,k,Y,F,G,X,B,W]),$=s.useMemo((function(){return{TUIMessage:S||u.TUIMessage,MessageContext:P,InputPlugins:f,MessagePlugins:q,TUIChatHeader:E,TUIMessageInput:U,InputQuote:H}}),[]);return t.jsx("div",e.__assign({className:"chat ".concat(m)},{children:t.jsx(r.TUIChatStateContextProvider,e.__assign({value:O},{children:t.jsx(n.TUIChatActionProvider,e.__assign({value:Z},{children:t.jsx(i.ComponentProvider,e.__assign({value:$},{children:x||t.jsxs(t.Fragment,{children:[t.jsx(_.TUIChatHeader,{}),t.jsx(v.TUIMessageList,{}),t.jsx(C.TUIMessageInput,{})]})}))}))}))}))}var x=p(s).default.memo(j);exports.TUIChat=x;
